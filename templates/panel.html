<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Baru - Kolejka zamówień</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      transition: background-color 0.5s;
      background-color: white;
    }
    #toggleAlarm {
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
    .order {
      margin: 10px;
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Kolejka zamówień</h1>
  <button id="toggleAlarm">Wyłącz alarm</button>
  <div id="orders"></div>

  <script>
    (function() {
      let orders = [];
      let prevCount = 0;
      let pulseInterval = null;
      let alarmEnabled = true;
      const POLL_INTERVAL = 2000;

      // Pierwsze odnalezienie elementów
      const btnToggle = document.getElementById('toggleAlarm');
      const ordersContainer = document.getElementById('orders');

      btnToggle.addEventListener('click', () => {
        alarmEnabled = false;
        stopPulsing();
      });

      function randomColor() {
        const r = Math.floor(Math.random() * 256);
        const g = Math.floor(Math.random() * 256);
        const b = Math.floor(Math.random() * 256);
        return `rgb(${r},${g},${b})`;
      }

      function startPulsing() {
        if (!alarmEnabled || pulseInterval) return;
        pulseInterval = setInterval(() => {
          document.body.style.backgroundColor = randomColor();
        }, POLL_INTERVAL);
      }

      function stopPulsing() {
        if (pulseInterval) {
          clearInterval(pulseInterval);
          pulseInterval = null;
        }
        document.body.style.backgroundColor = 'white';
      }

      function renderList() {
        ordersContainer.innerHTML = '';
        orders.forEach(o => {
          const div = document.createElement('div');
          div.className = 'order';
          div.innerHTML = `
            #${o.id} | Biurko ${o.desk} | ${o.items}
            <button data-id="${o.id}" class="done">Wydano</button>
          `;
          ordersContainer.appendChild(div);
        });

        // Reakcja na przyrost zamówień
        if (orders.length > prevCount) {
          alarmEnabled = true;
        }
        prevCount = orders.length;

        // Sterowanie alarmem
        if (orders.length > 0 && alarmEnabled) {
          startPulsing();
        } else {
          stopPulsing();
        }

        // Podpinamy listener do nowych przycisków „Wydano”
        document.querySelectorAll('.done').forEach(btn => {
          btn.onclick = async () => {
            const id = btn.getAttribute('data-id');
            await fetch(`/api/order/${id}`, { method: 'DELETE' });
            fetchOrders();
          };
        });
      }

      async function fetchOrders() {
        try {
          const res = await fetch('/api/orders');
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          orders = await res.json();
          renderList();
        } catch (e) {
          console.error('fetchOrders error:', e);
        }
      }

      // Startujemy polling
      window.addEventListener('load', () => {
        fetchOrders();
        setInterval(fetchOrders, POLL_INTERVAL);
      });
    })();
  </script>
</body>
</html>
